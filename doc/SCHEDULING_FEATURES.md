# 排班管理功能说明

## 功能概述

排班管理功能允许旅行社为旅行团安排导游和车辆，确保资源不冲突，并优化资源利用率。

## 主要功能

### 1. 排班列表页面 (`/scheduling`)
- 显示所有需要排班的旅行团（状态为 planned 或 paid）
- 显示旅行团基本信息：名称、行程、状态、日期等
- 提供统计信息：总旅行团数、各状态分布、团员统计等
- 点击"开始排班"进入具体旅行团的排班管理页面

### 2. 排班详情页面 (`/scheduling/[id]`)
- 显示旅行团详细信息：名称、行程、天数、日期范围
- 提供排班操作：复制到每一天、保存排班安排
- 每日排班安排表格：
  - 日期（第几天）
  - 导游选择（多选，显示可用性）
  - 车辆选择（单选，显示可用性）
  - 住宿安排
  - 备注信息
- 资源可用性概览：
  - 导游可用性表格（显示前7天的可用状态）
  - 车辆可用性表格（显示前7天的可用状态）

### 3. 核心特性

#### 自动冲突检测
- 系统自动检查导游和车辆在指定日期的可用性
- 已占用的资源会显示为不可用状态
- 保存时会进行冲突检查，防止重复安排

#### 快速复制功能
- 设置第一天的安排后，可以一键复制到所有日期
- 大大减少重复输入工作

#### 实时可用性显示
- 导游和车辆选择下拉框中会显示可用状态
- 已占用的资源会标记为"(已占用)"并禁用选择

## API 端点

### 1. 获取排班信息
```
GET /api/scheduling/tour/[id]?startDate={startDate}&endDate={endDate}
```
- 获取旅行团在指定日期范围内的排班信息
- 返回导游和车辆的可用性数据

### 2. 保存排班安排
```
POST /api/scheduling/tour/[id]
```
- 保存旅行团的排班安排
- 自动检查资源冲突
- 返回冲突信息或成功消息

### 3. 检查可用性
```
POST /api/scheduling/availability
```
- 检查指定导游和车辆在指定日期的可用性
- 用于实时验证排班安排

## 数据流程

1. **初始化**：用户进入排班页面，系统获取旅行团信息和日期范围
2. **获取可用性**：根据日期范围查询导游和车辆的可用性
3. **排班设置**：用户设置每日的导游、车辆、住宿和备注
4. **冲突检查**：保存前系统检查是否有资源冲突
5. **数据保存**：将排班安排保存到 `bookings` 表

## 数据结构

### DailyAssignment
```typescript
interface DailyAssignment {
  date: string
  guides: Array<{
    id: string
    name: string
  }>
  vehicle: {
    id: string
    plateNumber: string
  } | null
  accommodation: string
  notes: string
}
```

### 保存到数据库
排班数据保存在 `bookings` 表中：
- `assignedGuides`: JSON 数组，包含每日导游安排
- `assignedVehicle`: JSON 数组，包含每日车辆安排
- `assignedAccommodations`: JSON 数组，包含每日住宿安排

## 使用说明

### 基本操作流程
1. 在排班列表页面选择要安排的旅行团
2. 点击"开始排班"进入排班详情页面
3. 设置第一天的导游、车辆、住宿和备注
4. 点击"复制到每一天"快速应用到所有日期
5. 根据需要调整特定日期的安排
6. 点击"保存排班安排"完成排班

### 注意事项
- 旅行团必须设置开始和结束日期才能进行排班
- 系统会自动检查资源冲突，已占用的资源无法选择
- 保存前建议检查所有日期的安排是否正确
- 可以随时修改和重新保存排班安排

## 技术实现

- 前端：React + TypeScript + Tailwind CSS
- 后端：Next.js API Routes + Prisma ORM
- 数据库：PostgreSQL
- 状态管理：React Hooks (useState, useEffect)
- 路由：Next.js App Router

## 权限控制

- 旅行社用户只能查看和编辑自己旅行社的排班安排
- 平台超级管理员可以查看所有排班安排
- 需要有效的认证令牌才能访问排班功能 