# 排班管理功能说明

## 功能概述

排班管理功能允许旅行社管理员为旅行团安排导游和车辆，并将所有数据保存到`itineraries`表的`activities.guides`字段中。

## 核心特性

### 1. 资源可用性查询
- 点击"开始排班"后，系统自动查询指定日期范围内所有可用导游和车辆
- 显示每个资源在每一天的可用性状态
- 自动检测资源冲突（已被其他旅行团占用）

### 2. 排班安排
- 手动输入第一天的导游、车辆、住宿安排和备注
- 支持多个导游同时安排
- 支持车辆分配
- 支持导游住宿信息记录

### 3. 快速复制
- "复制到每一天"功能，将第一天的安排快速应用到所有日期
- 减少重复输入，提高工作效率

### 4. 冲突检测
- 自动检测导游和车辆在指定日期的占用情况
- 实时显示冲突信息
- 防止重复安排导致的资源冲突

### 5. 数据持久化
- 所有排班数据保存到`itineraries`表的`activities.guides`字段
- 符合PRD文档中定义的数据结构
- 支持修改和更新现有安排

## 数据结构

### 保存到数据库的格式

```json
{
  "activities": [
    {
      "day": 1,
      "description": "抵达苏黎世，自由活动",
      "hotelInfo": { ... },
      "guides": [
        {
          "guideId": "g001",
          "vehicleId": "v001",
          "guideAccommodation": {
            "hotelName": "Big Hotel",
            "notes": "standard, 2025.8.19"
          },
          "status": "已安排"
        }
      ]
    }
  ]
}
```

### 前端数据结构

```typescript
interface DailyAssignment {
  date: string
  guides: Array<{
    id: string
    name: string
  }>
  vehicle: {
    id: string
    plateNumber: string
  } | null
  accommodation: string
  notes: string
}
```

## API接口

### GET /api/scheduling/tour/[id]
获取旅行团排班信息，包括：
- 旅行团基本信息
- 可用导游列表及其每日可用性
- 可用车辆列表及其每日可用性
- 日期范围

**查询参数：**
- `startDate`: 开始日期 (YYYY-MM-DD)
- `endDate`: 结束日期 (YYYY-MM-DD)

### POST /api/scheduling/tour/[id]
保存排班安排

**请求体：**
```json
{
  "startDate": "2025-08-19",
  "endDate": "2025-08-25",
  "dailyAssignments": [
    {
      "date": "2025-08-19",
      "guides": [{"id": "g001", "name": "张三"}],
      "vehicle": {"id": "v001", "plateNumber": "京A12345"},
      "accommodation": "Big Hotel",
      "notes": "标准间"
    }
  ],
  "notes": "总体备注"
}
```

## 使用流程

### 1. 开始排班
1. 在排班列表页面点击"开始排班"
2. 系统自动查询旅行团日期范围内的可用资源
3. 显示导游和车辆的可用性表格

### 2. 设置第一天安排
1. 选择第一天的导游（可多选）
2. 选择第一天的车辆
3. 输入导游住宿安排
4. 添加备注信息

### 3. 复制到所有日期
1. 点击"复制到每一天"按钮
2. 系统自动将第一天的安排复制到所有后续日期
3. 检查并调整各日期的具体安排

### 4. 解决冲突
1. 系统自动检测资源冲突
2. 查看冲突详情
3. 手动调整冲突日期的安排
4. 重新分配资源

### 5. 保存排班
1. 点击"保存排班安排"按钮
2. 系统验证数据完整性
3. 保存到数据库
4. 返回排班列表页面

## 权限控制

- 只有旅行社管理员和排班员可以访问排班功能
- 用户只能查看和操作自己旅行社的旅行团
- 平台超级管理员可以查看所有旅行社的排班信息

## 技术实现

### 前端
- React + TypeScript
- Tailwind CSS 样式
- 响应式设计，支持移动端

### 后端
- Next.js API Routes
- Prisma ORM
- PostgreSQL 数据库
- JSON字段查询和更新

### 数据库
- 使用PostgreSQL的JSONB类型存储复杂数据结构
- 创建GIN索引提高JSON查询性能
- 支持JSON路径查询进行冲突检测

## 注意事项

1. **数据完整性**: 确保旅行团已绑定行程（itinerary）才能进行排班
2. **冲突检测**: 系统会自动检测资源冲突，但建议手动复查
3. **数据备份**: 排班数据会覆盖现有的activities字段，请确保数据备份
4. **性能考虑**: 对于大量数据的查询，系统使用了适当的索引优化

## 故障排除

### 常见问题

1. **"旅行团未绑定行程"错误**
   - 解决方案：先为旅行团创建或绑定行程

2. **"权限不足"错误**
   - 解决方案：检查用户角色和旅行社归属

3. **资源冲突检测不准确**
   - 解决方案：检查数据库中的JSON数据格式是否正确

4. **页面加载缓慢**
   - 解决方案：检查数据库索引是否正确创建

### 日志查看

排班相关的错误日志会记录在：
- 前端：浏览器控制台
- 后端：服务器日志文件

## 更新历史

- 2025-01-XX: 初始版本，实现基本排班功能
- 2025-01-XX: 删除booking表，改用itineraries.activities字段
- 2025-01-XX: 优化冲突检测算法
- 2025-01-XX: 添加数据验证和错误处理 