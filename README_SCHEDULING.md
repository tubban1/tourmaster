# 排班管理系统 - 完整实现

## 项目概述

本项目重新设计并实现了完整的排班管理功能，用于为旅行团安排导游和车辆，确保资源不冲突，并优化资源利用率。

## 已实现的功能

### 1. 排班管理主页面 (`/scheduling`)
- ✅ 显示所有需要排班的旅行团列表
- ✅ 旅行团基本信息展示（名称、行程、状态、日期等）
- ✅ 统计信息展示（总旅行团数、各状态分布、团员统计等）
- ✅ 导航到具体旅行团的排班管理页面

### 2. 排班详情页面 (`/scheduling/[id]`)
- ✅ 旅行团详细信息展示
- ✅ 每日排班安排表格（导游、车辆、住宿、备注）
- ✅ 导游多选功能（显示可用性状态）
- ✅ 车辆单选功能（显示可用性状态）
- ✅ 住宿和备注输入字段
- ✅ "复制到每一天"功能
- ✅ "保存排班安排"功能
- ✅ 资源可用性概览表格

### 3. 后端API
- ✅ `GET /api/scheduling/tour/[id]` - 获取排班信息
- ✅ `POST /api/scheduling/tour/[id]` - 保存排班安排
- ✅ `POST /api/scheduling/availability` - 检查资源可用性
- ✅ 自动冲突检测和验证
- ✅ 权限控制和数据安全

### 4. 核心特性
- ✅ 自动冲突检测：防止导游和车辆重复安排
- ✅ 实时可用性显示：已占用资源会标记并禁用
- ✅ 快速复制功能：一键复制第一天的安排到所有日期
- ✅ 数据持久化：排班数据保存到数据库
- ✅ 响应式设计：支持不同屏幕尺寸

## 技术架构

### 前端技术栈
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **状态管理**: React Hooks
- **组件**: 自定义组件 + 布局组件

### 后端技术栈
- **框架**: Next.js API Routes
- **数据库**: PostgreSQL
- **ORM**: Prisma
- **认证**: JWT Token
- **权限控制**: 基于角色的访问控制

### 数据库设计
- **主要表**: `bookings` (排班记录)
- **关联表**: `tours`, `tour_guides`, `vehicles`
- **数据结构**: JSON字段存储复杂的排班安排

## 文件结构

```
tourmaster.ch/
├── src/
│   ├── app/
│   │   ├── scheduling/
│   │   │   ├── page.tsx                    # 排班管理主页面
│   │   │   └── [id]/
│   │   │       └── page.tsx                # 排班详情页面
│   │   └── api/
│   │       └── scheduling/
│   │           ├── tour/
│   │           │   └── [id]/
│   │           │       └── route.ts        # 排班管理API
│   │           └── availability/
│   │               └── route.ts            # 可用性检查API
│   └── components/
│       └── AppLayout.tsx                   # 应用布局组件
├── prisma/
│   └── schema.prisma                       # 数据库模式
├── doc/
│   └── SCHEDULING_FEATURES.md              # 功能详细说明
├── test-scheduling.js                       # API测试脚本
└── README_SCHEDULING.md                     # 本文档
```

## 使用方法

### 1. 启动项目
```bash
cd tourmaster.ch
npm install
npm run dev
```

### 2. 访问排班管理
- 打开浏览器访问 `http://localhost:3000/scheduling`
- 查看需要排班的旅行团列表
- 点击"开始排班"进入具体旅行团的排班管理

### 3. 进行排班安排
1. 设置第一天的导游、车辆、住宿和备注
2. 点击"复制到每一天"快速应用到所有日期
3. 根据需要调整特定日期的安排
4. 点击"保存排班安排"完成排班

### 4. 测试API
```bash
node test-scheduling.js
```

## 数据流程

```
用户操作 → 前端验证 → API调用 → 冲突检查 → 数据保存 → 成功反馈
    ↓
数据库更新 → 排班记录创建 → 资源状态更新
```

## 权限控制

- **旅行社用户**: 只能查看和编辑自己旅行社的排班安排
- **平台超级管理员**: 可以查看所有排班安排
- **认证要求**: 需要有效的JWT令牌才能访问排班功能

## 错误处理

- **输入验证**: 前端和后端双重验证
- **冲突检测**: 自动检测资源冲突并阻止保存
- **错误反馈**: 清晰的错误消息和用户指导
- **异常处理**: 完善的异常捕获和日志记录

## 性能优化

- **数据分页**: 大量数据的分页显示
- **缓存策略**: 减少重复的数据库查询
- **响应式设计**: 优化不同设备的用户体验
- **代码分割**: 按需加载组件和功能

## 扩展性

- **模块化设计**: 易于添加新的排班功能
- **配置化**: 支持不同的排班规则和策略
- **API设计**: RESTful API便于第三方集成
- **数据库设计**: 灵活的JSON字段支持复杂数据结构

## 测试建议

1. **功能测试**: 测试所有排班功能是否正常工作
2. **冲突测试**: 测试资源冲突检测是否准确
3. **权限测试**: 测试不同角色的权限控制
4. **性能测试**: 测试大量数据下的性能表现
5. **兼容性测试**: 测试不同浏览器的兼容性

## 部署说明

1. **环境变量**: 配置数据库连接和JWT密钥
2. **数据库迁移**: 运行Prisma迁移脚本
3. **构建部署**: 使用Next.js构建和部署
4. **监控日志**: 配置应用监控和日志记录

## 维护和更新

- **定期备份**: 定期备份排班数据
- **性能监控**: 监控API响应时间和数据库性能
- **功能更新**: 根据用户反馈持续改进功能
- **安全更新**: 及时更新依赖包和安全补丁

## 联系和支持

如有问题或建议，请联系开发团队或查看项目文档。 